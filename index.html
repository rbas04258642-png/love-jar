<!doctype html>
<html lang="ar">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>جرة الحب — Love ❤</title>
<meta name="description" content="جرة الحب — أرسل رسائل حب مع صور، وشارك رابط قصير يصل المتلقي للرسائل" />
<style>
:root{
  --bg:#fff7f7;
  --card:#fff;
  --accent:#8b0000; /* أحمر داكن */
  --accent-soft:#ff4d4d;
  --muted:#8a8a8a;
  --radius:14px;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:system-ui,-apple-system,'Segoe UI',Roboto,'Noto Sans Arabic',Arial;background:linear-gradient(180deg,#fff7f7 0%,#fff 100%);color:#222;display:flex;align-items:center;justify-content:center;padding:18px}
.container{width:100%;max-width:980px;display:grid;grid-template-columns:1fr 420px;gap:18px;align-items:start;}
.card{background:var(--card);border-radius:var(--radius);padding:18px;box-shadow:0 6px 24px rgba(139,0,0,0.06)}
.header{display:flex;align-items:center;gap:12px}
.logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent) 0%,var(--accent-soft) 100%);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:20px}
.title{font-size:20px;color:var(--accent);margin:0}
.subtitle{color:var(--muted);font-size:13px;margin-top:6px}

/* form */
.form-row{display:flex;gap:10px;margin-top:12px}
label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
input[type=text],textarea,input[type=file]{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(139,0,0,0.06);font-size:14px;background:transparent}
textarea{min-height:84px;resize:vertical}
.actions{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap}
.btn{background:var(--accent);color:#fff;border:0;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600}
.btn.ghost{background:#fff;border:1px solid rgba(139,0,0,0.12);color:var(--accent)}
.note{font-size:13px;color:var(--muted);margin-top:8px}

/* messages */
.messages{margin-top:12px;max-height:260px;overflow:auto;border-radius:10px;padding:8px;background:linear-gradient(180deg,rgba(139,0,0,0.03),rgba(139,0,0,0.01))}
.msg{display:flex;gap:10px;align-items:center;background:#fff;border-radius:8px;padding:8px;margin-bottom:8px;cursor:pointer;box-shadow:0 1px 6px rgba(0,0,0,0.03)}
.msg .thumb{width:44px;height:44px;border-radius:6px;object-fit:cover;border:1px solid rgba(139,0,0,0.06)}
.msg .text{font-size:14px;color:#222}

/* jar (heart) */
.preview-wrap{text-align:center}
.heart-jar{width:100%;max-width:340px;margin:0 auto;position:relative}
.heart-svg{width:100%;height:auto;display:block}
.hearts-layer{position:absolute;inset:0;pointer-events:none;overflow:hidden}
.heart-bubble{position:absolute;font-size:20px;opacity:0;transform:translateY(60px) scale(.6);animation:float 3s linear infinite}
@keyframes float{
0%{opacity:0;transform:translateY(120px) scale(.6)}
10%{opacity:1}
70%{opacity:0.9;transform:translateY(-30px) scale(1)}
100%{opacity:0;transform:translateY(-80px) scale(.8)}
}

/* footer */
.footer{margin-top:12px;text-align:center;color:var(--muted);font-size:13px}
.footer a{color:var(--accent);text-decoration:none;font-weight:600}

/* responsive vertical layout on small screens */
@media(max-width:920px){
  .container{grid-template-columns:1fr;gap:14px}
  .heart-jar{max-width:260px}
  .messages{max-height:200px}
}
</style>
</head>
<body>
<main class="container" role="main">

  <!-- LEFT: form -->
  <section class="card" aria-labelledby="title">
    <div class="header">
      <div class="logo">Love</div>
      <div>
        <h1 id="title" class="title">جرة الحب ❤</h1>
        <div class="subtitle">أضف رسالة وصورة — وشارك الرابط القصير</div>
      </div>
    </div>

    <div style="margin-top:12px">
      <div class="form-row">
        <div style="flex:1">
          <label for="from">اكتب اسمك</label>
          <input id="from" type="text" placeholder="مثال: عباس" />
        </div>
        <div style="width:150px">
          <label for="to">إلى</label>
          <input id="to" type="text" placeholder="مثال: سارة" />
        </div>
      </div>

      <div style="margin-top:12px">
        <label for="msg">اكتب رسالة قصيرة</label>
        <textarea id="msg" placeholder="ماذا تريد أن تقول؟ ..."></textarea>
        <label style="margin-top:8px;font-size:13px;color:var(--muted)">أرفق صورة (اختياري)</label>
        <input id="file" type="file" accept="image/*" />
        <div class="actions">
          <button id="add" class="btn">أضف إلى الجرة ❤</button>
          <button id="clear" class="btn ghost">مسح الكل</button>
          <button id="share" class="btn" title="انشاء رابط قابل للمشاركة">إنشاء رابط قابل للمشاركة</button>
        </div>
        <div class="note">اضغط على أي رسالة في القائمة لنسخ النص إلى الحافظة</div>

        <div class="messages" id="list" aria-live="polite" style="margin-top:12px">
          <em style="color:var(--muted)">لا توجد رسائل حتى الآن</em>
        </div>

        <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
          <input id="shareLink" readonly style="flex:1;padding:8px;border-radius:8px;border:1px solid rgba(139,0,0,0.08);background:#fff" />
          <button id="copyLink" class="btn ghost">نسخ</button>
        </div>

        <div class="footer">توقيع: <strong>عباس الأسدي</strong> — <a href="https://instagram.com/j45fl" target="_blank">@j45fl</a></div>
      </div>
    </div>
  </section>

  <!-- RIGHT: preview jar -->
  <aside class="card preview-wrap" aria-label="معاينة الجرة">
    <div style="margin-bottom:8px">
      <strong id="previewTitle">إهداء خاص ❤</strong>
      <div id="previewSub" style="color:var(--muted);font-size:13px;margin-top:6px">لم يتم تعيين الأسماء بعد</div>
    </div>

    <div class="heart-jar" id="jar">
      <!-- Heart-shaped jar SVG (small, elegant) -->
      <svg class="heart-svg" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <defs>
          <linearGradient id="g1" x1="0" x2="1" y1="0" y2="1">
            <stop offset="0%" stop-color="#fff" stop-opacity="0.6"/>
            <stop offset="100%" stop-color="#ffeded" stop-opacity="0.3"/>
          </linearGradient>
        </defs>
        <path d="M100 170 C40 120 20 90 40 60 C60 30 95 38 100 60 C105 38 140 30 160 60 C180 90 160 120 100 170 Z"
          fill="url(#g1)" stroke="rgba(139,0,0,0.12)" stroke-width="2"/>
      </svg>
      <div class="hearts-layer" id="heartsLayer" aria-hidden="true"></div>
    </div>

    <div style="margin-top:12px;text-align:center">
      <strong>محتوى الجرة</strong>
      <div id="preview" style="color:var(--muted);font-size:13px;margin-top:8px;max-height:200px;overflow:auto"></div>
    </div>
  </aside>

</main>

<!-- LZ-String (compress/decompress) - small implemented functions -->
<script>
/*
  Minimal LZ-based compressToEncodedURIComponent / decompressFromEncodedURIComponent
  (adapted from LZ-String) to shorten the URL payload.
*/
const LZStringMini = (function(){
  // from lz-string (compressed version) - functions used: compressToEncodedURIComponent, decompressFromEncodedURIComponent
  const f = String.fromCharCode;
  function compressToEncodedURIComponent(input){
    if(input==null) return "";
    const res = _compress(input,6, (a)=> "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$".charAt(a));
    return res;
  }
  function _compress(uncompressed, bitsPerChar, getCharFromInt){
    if(uncompressed==null) return "";
    let i, value, context_dictionary = {}, context_dictionaryToCreate = {}, context_c="", context_wc="", context_w="", context_enlargeIn=2, context_dictSize=3, context_numBits=2, context_data=[], context_data_val=0, context_data_position=0;
    for (i = 0; i < uncompressed.length; i += 1) {
      context_c = uncompressed.charAt(i);
      if (!Object.prototype.hasOwnProperty.call(context_dictionary,context_c)) {
        context_dictionary[context_c] = context_dictSize++;
        context_dictionaryToCreate[context_c] = true;
      }
      context_wc = context_w + context_c;
      if (Object.prototype.hasOwnProperty.call(context_dictionary,context_wc)) {
        context_w = context_wc;
      } else {
        if (Object.prototype.hasOwnProperty.call(context_dictionaryToCreate,context_w)) {
          value = context_w.charCodeAt(0);
          if (value<256) {
            for (let j=0;j<context_numBits;j++) {
              context_data_val = (context_data_val << 1);
              if (context_data_position==bitsPerChar-1) { context_data_position=0; context_data.push(getCharFromInt(context_data_val)); context_data_val=0; } else context_data_position++;
            }
            for (let j=0;j<8;j++) {
              context_data_val = (context_data_val << 1) | (value & 1);
              if (context_data_position==bitsPerChar-1) { context_data_position=0; context_data.push(getCharFromInt(context_data_val)); context_data_val=0; } else context_data_position++;
              value = value >> 1;
            }
          } else {
            value = 1;
            for (let j=0;j<context_numBits;j++) {
              context_data_val = (context_data_val << 1) | value;
              if (context_data_position==bitsPerChar-1) { context_data_position=0; context_data.push(getCharFromInt(context_data_val)); context_data_val=0; } else context_data_position++;
              value = 0;
            }
            value = context_w.charCodeAt(0);
            for (let j=0;j<16;j++) {
              context_data_val = (context_data_val << 1) | (value & 1);
              if (context_data_position==bitsPerChar-1) { context_data_position=0; context_data.push(getCharFromInt(context_data_val)); context_data_val=0; } else context_data_position++;
              value = value >> 1;
            }
          }
          context_enlargeIn--;
          if (context_enlargeIn==0) { context_enlargeIn = Math.pow(2, context_numBits); context_numBits++; }
          delete context_dictionaryToCreate[context_w];
        } else {
          value = context_dictionary[context_w];
          for (let j=0;j<context_numBits;j++) {
            context_data_val = (context_data_val << 1) | (value & 1);
            if (context_data_position==bitsPerChar-1) { context_data_position=0; context_data.push(getCharFromInt(context_data_val)); context_data_val=0; } else context_data_position++;
            value = value >> 1;
          }
        }
        context_enlargeIn--;
        if (context_enlargeIn==0) { context_enlargeIn = Math.pow(2, context_numBits); context_numBits++; }
        // add wc to the dictionary.
        context_dictionary[context_wc] = context_dictSize++;
        context_w = String(context_c);
      }
    }
    if (context_w !== "") {
      if (Object.prototype.hasOwnProperty.call(context_dictionaryToCreate,context_w)) {
        value = context_w.charCodeAt(0);
        if (value<256) {
          for (let j=0;j<context_numBits;j++) {
            context_data_val = (context_data_val << 1);
            if (context_data_position==bitsPerChar-1) { context_data_position=0; context_data.push(getCharFromInt(context_data_val)); context_data_val=0; } else context_data_position++;
          }
          for (let j=0;j<8;j++) {
            context_data_val = (context_data_val << 1) | (value & 1);
            if (context_data_position==bitsPerChar-1) { context_data_position=0; context_data.push(getCharFromInt(context_data_val)); context_data_val=0; } else context_data_position++;
            value = value >> 1;
          }
        } else {
          value = 1;
          for (let j=0;j<context_numBits;j++) {
            context_data_val = (context_data_val << 1) | value;
            if (context_data_position==bitsPerChar-1) { context_data_position=0; context_data.push(getCharFromInt(context_data_val)); context_data_val=0; } else context_data_position++;
            value = 0;
          }
          value = context_w.charCodeAt(0);
          for (let j=0;j<16;j++) {
            context_data_val = (context_data_val << 1) | (value & 1);
            if (context_data_position==bitsPerChar-1) { context_data_position=0; context_data.push(getCharFromInt(context_data_val)); context_data_val=0; } else context_data_position++;
            value = value >> 1;
          }
        }
        context_enlargeIn--;
        if (context_enlargeIn==0) { context_enlargeIn = Math.pow(2, context_numBits); context_numBits++; }
        delete context_dictionaryToCreate[context_w];
      } else {
        value = context_dictionary[context_w];
        for (let j=0;j<context_numBits;j++) {
          context_data_val = (context_data_val << 1) | (value & 1);
          if (context_data_position==bitsPerChar-1) { context_data_position=0; context_data.push(getCharFromInt(context_data_val)); context_data_val=0; } else context_data_position++;
          value = value >> 1;
        }
      }
      context_enlargeIn--;
      if (context_enlargeIn==0) { context_enlargeIn = Math.pow(2, context_numBits); context_numBits++; }
    }
    // mark the end
    value = 2;
    for (let j=0;j<context_numBits;j++) {
      context_data_val = (context_data_val << 1) | (value & 1);
      if (context_data_position==bitsPerChar-1) { context_data_position=0; context_data.push(getCharFromInt(context_data_val)); context_data_val=0; } else context_data_position++;
      value = value >> 1;
    }
    // flush the last char
    while (true) {
      context_data_val = (context_data_val << 1);
      if (context_data_position==bitsPerChar-1) { context_data.push(getCharFromInt(context_data_val)); break; } else context_data_position++;
    }
    return context_data.join('');
  }

  function decompressFromEncodedURIComponent(input){
    if(input==null) return "";
    return _decompress(input.length, 32, (index)=> "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$".indexOf(input.charAt(index)));
  }
  function _decompress(length, resetValue, getNextValue){
    let dictionary = [], next, enlargeIn = 4, dictSize = 4, numBits = 3, entry = "", result = [], i, w, bits, resb, maxpower, power, c, data = {val:getNextValue(0), position:resetValue, index:1};
    for (i=0;i<3;i+=1) dictionary[i] = i;
    bits = 0; maxpower = Math.pow(2,2); power = 1;
    while (power!=maxpower) {
      resb = data.val & data.position;
      data.position >>= 1;
      if (data.position==0){ data.position = resetValue; data.val = getNextValue(data.index++); }
      bits |= (resb>0?1:0) * power;
      power <<= 1;
    }
    switch (next = bits) {
      case 0: bits = 0; maxpower = Math.pow(2,8); power = 1; while (power!=maxpower) { resb = data.val & data.position; data.position >>= 1; if (data.position==0){ data.position = resetValue; data.val = getNextValue(data.index++); } bits |= (resb>0?1:0) * power; power <<= 1; } c = f(bits); break;
      case 1: bits = 0; maxpower = Math.pow(2,16); power = 1; while (power!=maxpower) { resb = data.val & data.position; data.position >>= 1; if (data.position==0){ data.position = resetValue; data.val = getNextValue(data.index++); } bits |= (resb>0?1:0) * power; power <<= 1; } c = f(bits); break;
      case 2: return "";
    }
    dictionary[3] = c;
    w = c;
    result.push(c);
    while (true) {
      if (data.index > length) return "";
      bits = 0; maxpower = Math.pow(2,numBits); power = 1;
      while (power!=maxpower) { resb = data.val & data.position; data.position >>= 1; if (data.position==0){ data.position = resetValue; data.val = getNextValue(data.index++); } bits |= (resb>0?1:0) * power; power <<= 1; }
      switch (c = bits) {
        case 0: bits = 0; maxpower = Math.pow(2,8); power = 1; while (power!=maxpower) { resb = data.val & data.position; data.position >>= 1; if (data.position==0){ data.position = resetValue; data.val = getNextValue(data.index++); } bits |= (resb>0?1:0) * power; power <<= 1; } dictionary[dictSize++] = f(bits); c = dictSize-1; enlargeIn--; break;
        case 1: bits = 0; maxpower = Math.pow(2,16); power = 1; while (power!=maxpower) { resb = data.val & data.position; data.position >>= 1; if (data.position==0){ data.position = resetValue; data.val = getNextValue(data.index++); } bits |= (resb>0?1:0) * power; power <<= 1; } dictionary[dictSize++] = f(bits); c = dictSize-1; enlargeIn--; break;
        case 2: return result.join(''); 
      }
      if (enlargeIn==0){ enlargeIn = Math.pow(2, numBits); numBits++; }
      if (dictionary[c]) entry = dictionary[c];
      else {
        if (c === dictSize) entry = w + w.charAt(0);
        else return null;
      }
      result.push(entry);
      // add w+entry[0] to the dictionary.
      dictionary[dictSize++] = w + entry.charAt(0);
      enlargeIn--;
      w = entry;
      if (enlargeIn==0){ enlargeIn = Math.pow(2, numBits); numBits++; }
    }
  }

  return {compressToEncodedURIComponent, decompressFromEncodedURIComponent};
})();
</script>

<script>
/* ---------- Utility: resize image to limit before encoding (reduce link size) ---------- */
function resizeFileToDataURL(file, maxWidth=800, maxHeight=800, quality=0.75){
  return new Promise((resolve, reject)=>{
    const img = new Image();
    const reader = new FileReader();
    reader.onload = e => {
      img.onload = () => {
        let w = img.width, h = img.height;
        const ratio = Math.min(maxWidth / w, maxHeight / h, 1);
        w = Math.round(w * ratio); h = Math.round(h * ratio);
        const canvas = document.createElement('canvas');
        canvas.width = w; canvas.height = h;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img,0,0,w,h);
        // toDataURL with quality
        const dataUrl = canvas.toDataURL('image/jpeg', quality);
        resolve(dataUrl);
      };
      img.onerror = ()=> reject(new Error('فشل قراءة الصورة'));
      img.src = e.target.result;
    };
    reader.onerror = ()=> reject(new Error('فشل قراءة الملف'));
    reader.readAsDataURL(file);
  });
}

/* ---------- App logic ---------- */
const $ = id=>document.getElementById(id);
let messages = [];

// render lists and preview
function render(){
  const list = $('list'); const preview = $('preview');
  list.innerHTML=''; preview.innerHTML='';
  if(messages.length===0){
    list.innerHTML = '<em style="color:var(--muted)">لا توجد رسائل حتى الآن</em>';
    preview.innerHTML = '<div style="color:var(--muted)">الجرّة فارغة</div>';
    updateHeartsLayer();
    return;
  }
  messages.forEach((m,idx)=>{
    const div = document.createElement('div'); div.className='msg';
    const thumb = document.createElement('img'); thumb.className='thumb msg-img';
    thumb.src = m.img || 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="80" height="80"></svg>';
    thumb.alt='صورة';
    thumb.style.width='48px'; thumb.style.height='48px';
    const text = document.createElement('div'); text.className='text';
    text.innerHTML = `<strong style="color:${m.name? 'var(--accent)':'#000'}">${m.name || ''}</strong><div style="font-size:13px;color:#222">${escapeHtml(m.text)}</div>`;
    div.appendChild(thumb); div.appendChild(text);
    div.addEventListener('click', ()=>{ navigator.clipboard?.writeText(m.text).then(()=>alert('نُسخ النص')) });
    list.appendChild(div);

    // preview content (simple cards)
    const p = document.createElement('div'); p.className='msg';
    p.style.flexDirection='column';
    p.innerHTML = `<div style="font-weight:700;color:var(--accent)">${escapeHtml(m.name||'')}</div>
                   <div style="margin-top:6px">${escapeHtml(m.text)}</div>
                   ${m.img? `<img src="${m.img}" style="max-width:100%;margin-top:8px;border-radius:8px">` : ''}`;
    preview.appendChild(p);
  });
  updateHeartsLayer();
}

// escape HTML to avoid injection
function escapeHtml(s){ if(!s) return ''; return s.replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]); }

/* hearts animation inside the heart */
function updateHeartsLayer(){
  const layer = $('heartsLayer'); layer.innerHTML='';
  const count = Math.min(8, Math.max(3, Math.floor(messages.length/1) + 2));
  for(let i=0;i<count;i++){
    const b = document.createElement('div'); b.className='heart-bubble';
    const left = Math.random()*70 + 10;
    const top = Math.random()*100 + 30;
    b.style.left = left + '%'; b.style.top = top + 'px';
    const dur = (2 + Math.random()*2).toFixed(2);
    b.style.animationDuration = dur + 's';
    // gradient red shades
    const hue = 0;
    const light = 50 + Math.random()*10;
    b.style.color = `hsl(${hue},100%,${light}%)`;
    b.textContent = '❤';
    layer.appendChild(b);
  }
}

// add message handler
$('add').addEventListener('click', async ()=>{
  const text = $('msg').value.trim();
  if(!text) return alert('اكتب رسالة أولاً');
  const name = $('from').value.trim() || 'من مجهول';
  const file = $('file').files[0];
  try{
    if(file){
      const dataUrl = await resizeFileToDataURL(file, 800, 800, 0.75);
      messages.unshift({name, text, img: dataUrl});
    } else {
      messages.unshift({name, text, img: null});
    }
    // keep list length reasonable
    if(messages.length>40) messages = messages.slice(0,40);
    $('msg').value=''; $('file').value='';
    render();
  }catch(err){
    alert('خطأ في قراءة الصورة: ' + err.message);
  }
});

// clear
$('clear').addEventListener('click', ()=>{ if(confirm('هل تريد مسح كل الرسائل؟')){ messages=[]; render(); $('shareLink').value=''; } });

// create share link (compressed)
$('share').addEventListener('click', ()=>{
  if(messages.length===0) return alert('أضف رسالة واحدة على الأقل قبل الإنشاء');
  const state = {from: $('from').value||'', to: $('to').value||'', msgs: messages, ts: Date.now()};
  try{
    const json = JSON.stringify(state);
    const compressed = LZStringMini.compressToEncodedURIComponent(json);
    const short = location.origin + location.pathname + '#d=' + compressed;
    $('shareLink').value = short;
    navigator.clipboard?.writeText(short).then(()=>alert('تم نسخ الرابط القصير!'));
  }catch(e){ alert('فشل إنشاء الرابط: ' + e.message); }
});

// copy link
$('copyLink').addEventListener('click', ()=>{ const v = $('shareLink').value; if(!v) return alert('لا يوجد رابط لنسخه'); navigator.clipboard?.writeText(v).then(()=>alert('تم النسخ')); });

// load from hash on startup
function loadFromHash(){
  const h = location.hash;
  if(!h) return;
  const m = h.match(/d=([^&]+)/);
  if(!m) return;
  try{
    const compressed = m[1];
    const json = LZStringMini.decompressFromEncodedURIComponent(compressed);
    const state = JSON.parse(json);
    // fill preview: hide left form to show only preview
    document.querySelectorAll('.card')[0].style.display = 'none';
    $('previewTitle').textContent = state.to? `إلى ${state.to} ❤` : 'إهداء خاص ❤';
    $('previewSub').textContent = state.from? `من ${state.from}` : '';
    messages = state.msgs || [];
    render();
  }catch(e){
    console.error('فشل فك الرابط', e);
  }
}

// init
render();
loadFromHash();

// optional: update preview titles when typing
['from','to'].forEach(id=>$(id).addEventListener('input', ()=>{
  $('previewTitle').textContent = $('to').value? `إلى ${$('to').value} ❤` : 'إهداء خاص ❤';
  $('previewSub').textContent = $('from').value? `من ${$('from').value}` : 'أضف اسمك';
}));
</script>
</body>
</html>
